<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZotWatch 文献归档</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bg-primary': '#f8fafc',
            'bg-card': '#ffffff',
            'bg-hover': '#f1f5f9',
            'text-primary': '#1e293b',
            'text-secondary': '#64748b',
            'border-color': '#e2e8f0',
            'accent': '#2563eb',
            'accent-hover': '#1d4ed8',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .content-container { max-width: 64rem; margin: 0 auto; padding: 0 1rem; }
    @media (min-width: 768px) { .content-container { padding: 0 2rem; } }
    .section-expand { transition: max-height 0.3s ease-out; overflow: hidden; }
    .section-expand.collapsed { max-height: 0; }
    .section-expand.expanded { max-height: none; }
    .view-btn.active { background-color: #2563eb; color: white; }
    .filter-tag { cursor: pointer; transition: all 0.2s; }
    .filter-tag:hover { background-color: #dbeafe; }
    .filter-tag.active { background-color: #2563eb; color: white; }
  </style>
</head>
<body class="bg-bg-primary min-h-screen text-text-primary">
  <!-- Header -->
  <header class="bg-bg-card border-b border-border-color sticky top-0 z-10">
    <div class="content-container py-4 md:py-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-text-primary">ZotWatch 文献归档</h1>
          <p class="text-xs md:text-sm text-text-secondary mt-1">
            共 {{ stats.total }} 篇论文 ·
            最后更新: {{ generated_at.strftime('%Y-%m-%d %H:%M') }} {{ timezone_name }}
          </p>
        </div>
        <!-- Stats badges -->
        <div class="flex flex-wrap gap-2">
          <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
            必读 {{ stats.must_read }}
          </span>
          <span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">
            推荐 {{ stats.consider }}
          </span>
          <span class="px-3 py-1 bg-bg-hover text-text-secondary rounded-full text-sm">
            参考 {{ stats.total - stats.must_read - stats.consider }}
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <nav class="bg-bg-card border-b border-border-color py-3">
    <div class="content-container">
      <!-- View Switcher -->
      <div class="flex flex-wrap items-center gap-3 mb-3">
        <span class="text-sm text-text-secondary">分组方式:</span>
        <div class="flex gap-1">
          <button class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover {{ 'active' if group_by == 'date' }}"
                  onclick="location.href='?group_by=date'">按日期</button>
          <button class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover {{ 'active' if group_by == 'venue' }}"
                  onclick="location.href='?group_by=venue'">按期刊</button>
          <button class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover {{ 'active' if group_by == 'source' }}"
                  onclick="location.href='?group_by=source'">按来源</button>
          <button class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover {{ 'active' if group_by == 'label' }}"
                  onclick="location.href='?group_by=label'">按标签</button>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap items-center gap-3">
        <span class="text-sm text-text-secondary">筛选:</span>
        <!-- Source Filter -->
        <div class="flex gap-1">
          {% for src in sources %}
          <span class="filter-tag px-2 py-1 bg-bg-hover rounded text-xs" data-filter="source" data-value="{{ src.source }}">
            {{ src.source }} ({{ src.count }})
          </span>
          {% endfor %}
        </div>
        <!-- Label Filter -->
        <div class="flex gap-1">
          <span class="filter-tag px-2 py-1 bg-green-50 text-green-700 rounded text-xs" data-filter="label" data-value="must_read">必读</span>
          <span class="filter-tag px-2 py-1 bg-amber-50 text-amber-700 rounded text-xs" data-filter="label" data-value="consider">推荐</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="py-6">
    <div class="content-container">
      {% for group_name, works in grouped_works.items() %}
      <section class="mb-8" data-group="{{ group_name }}">
        <!-- Group Header -->
        <div class="flex items-center justify-between mb-4 pb-2 border-b border-border-color">
          <h2 class="text-lg font-bold text-text-primary flex items-center gap-2">
            {% if group_by == 'label' %}
              {% if group_name == 'must_read' %}
              <span class="w-3 h-3 bg-green-500 rounded-full"></span>必读
              {% elif group_name == 'consider' %}
              <span class="w-3 h-3 bg-amber-500 rounded-full"></span>推荐
              {% else %}
              <span class="w-3 h-3 bg-gray-400 rounded-full"></span>参考
              {% endif %}
            {% else %}
              {{ group_name }}
            {% endif %}
          </h2>
          <span class="text-sm text-text-secondary">{{ works|length }} 篇</span>
        </div>

        <!-- Works List -->
        <div class="space-y-4">
          {% for work in works %}
          <article class="paper-card bg-bg-card rounded-lg border border-border-color overflow-hidden hover:border-accent/50 transition-colors"
                   data-source="{{ work.source }}"
                   data-label="{{ work.label }}"
                   data-venue="{{ work.venue or 'Unknown' }}">
            <div class="p-4 md:p-5">
              <!-- Header: Label + Source + Date -->
              <div class="flex items-center gap-2 mb-2 flex-wrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium
                  {% if work.label == 'must_read' %}bg-green-100 text-green-700 border border-green-300
                  {% elif work.label == 'consider' %}bg-amber-100 text-amber-700 border border-amber-300
                  {% else %}bg-bg-hover text-text-secondary border border-border-color{% endif %}">
                  {% if work.label == 'must_read' %}必读{% elif work.label == 'consider' %}推荐{% else %}参考{% endif %}
                </span>
                <span class="text-xs text-text-secondary">评分 {{ '%.2f'|format(work.score) }}</span>
                <span class="text-xs text-text-secondary">·</span>
                <span class="text-xs text-text-secondary">{{ work.source }}</span>
                <span class="text-xs text-text-secondary">· {{ work.published.strftime('%Y-%m-%d') if work.published else work.extra.run_date }}</span>
              </div>

              <!-- Title -->
              <div class="mb-2">
                <h3 class="text-base md:text-lg font-semibold text-text-primary leading-tight">
                  <a href="{{ work.url or '#' }}" target="_blank" rel="noopener" class="hover:text-accent transition-colors">
                    {{ work.title }}
                  </a>
                </h3>
                {% if work.translated_title %}
                <p class="text-sm text-text-secondary mt-0.5 leading-snug">{{ work.translated_title }}</p>
                {% endif %}
              </div>

              <!-- Venue + IF -->
              <div class="text-xs text-text-secondary mb-2" title="{{ work.venue or '' }}">
                {{ work.venue or '未知来源' }}
                {% if work.is_chinese_core %}
                  <span class="ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded">中文核心</span>
                {% elif work.impact_factor %}
                  <span class="ml-1 text-blue-600">(IF: {{ '%.1f'|format(work.impact_factor) }})</span>
                {% endif %}
              </div>

              <!-- Authors -->
              <p class="text-sm text-text-secondary mb-3">
                {{ work.authors[:5] | join('，') }}{% if work.authors|length > 5 %} 等{% endif %}
              </p>

              <!-- DOI -->
              {% if work.doi %}
              <div class="text-xs text-text-secondary mb-3">
                <span class="font-medium mr-1">DOI:</span>
                <a href="https://doi.org/{{ work.doi }}" target="_blank" rel="noopener" class="text-accent hover:underline">{{ work.doi }}</a>
              </div>
              {% endif %}

              <!-- Abstract (Collapsible) -->
              {% if work.abstract %}
              <div class="bg-bg-hover/50 rounded-lg p-3 mb-3 border border-border-color">
                <button onclick="toggleSection('abstract-{{ loop.index }}-{{ group_name|replace(' ', '-') }}')"
                        class="w-full text-left text-sm font-medium text-text-primary flex items-center justify-between">
                  <span>原文摘要</span>
                  <svg class="w-4 h-4 text-text-secondary transform transition-transform" id="icon-abstract-{{ loop.index }}-{{ group_name|replace(' ', '-') }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </button>
                <div id="abstract-{{ loop.index }}-{{ group_name|replace(' ', '-') }}" class="section-expand collapsed">
                  <p class="text-sm text-text-secondary mt-2 leading-relaxed">{{ work.abstract }}</p>
                </div>
              </div>
              {% endif %}

              <!-- AI Summary -->
              {% if work.summary %}
              <div class="bg-accent/10 rounded-lg p-3 mb-3 border border-accent/30">
                <h4 class="text-sm font-semibold text-accent mb-2 flex items-center">
                  <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-1H2a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z"/>
                  </svg>
                  AI 总结
                </h4>
                <div class="space-y-1.5 text-sm text-text-primary">
                  <p><span class="font-medium text-accent">研究问题：</span>{{ work.summary.bullets.research_question }}</p>
                  <p><span class="font-medium text-accent">研究方法：</span>{{ work.summary.bullets.methodology }}</p>
                  <p><span class="font-medium text-accent">主要发现：</span>{{ work.summary.bullets.key_findings }}</p>
                  <p><span class="font-medium text-accent">创新点：</span>{{ work.summary.bullets.innovation }}</p>
                </div>
              </div>
              {% endif %}

              <!-- Scores -->
              <div class="pt-3 border-t border-border-color">
                <div class="flex flex-wrap gap-2 text-xs">
                  <span class="px-2 py-1 bg-bg-hover rounded text-text-secondary">相似度 {{ '%.2f'|format(work.similarity) }}</span>
                  <span class="px-2 py-1 bg-bg-hover rounded text-text-secondary">
                    期刊影响力 {{ '%.2f'|format(work.impact_factor_score) }}
                  </span>
                </div>
              </div>
            </div>
          </article>
          {% endfor %}
        </div>
      </section>
      {% endfor %}
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-bg-card border-t border-border-color mt-12">
    <div class="content-container py-6 text-center text-sm text-text-secondary">
      灵感来自 <a href="https://github.com/Yorks0n/ZotWatch" class="text-accent hover:text-accent-hover transition-colors">ZotWatch</a>
      · 数据来源: arXiv, Crossref, EarthArXiv
    </div>
  </footer>

  <script>
    function toggleSection(id) {
      const el = document.getElementById(id);
      const icon = document.getElementById('icon-' + id);
      if (el.classList.contains('collapsed')) {
        el.classList.remove('collapsed');
        el.classList.add('expanded');
        if (icon) icon.style.transform = 'rotate(180deg)';
      } else {
        el.classList.remove('expanded');
        el.classList.add('collapsed');
        if (icon) icon.style.transform = 'rotate(0deg)';
      }
    }

    // Filter functionality
    document.querySelectorAll('.filter-tag').forEach(tag => {
      tag.addEventListener('click', function() {
        const filterType = this.dataset.filter;
        const filterValue = this.dataset.value;

        // Toggle active state
        this.classList.toggle('active');

        // Get all active filters
        const activeFilters = {
          source: [],
          label: []
        };

        document.querySelectorAll('.filter-tag.active').forEach(activeTag => {
          const type = activeTag.dataset.filter;
          const value = activeTag.dataset.value;
          if (!activeFilters[type].includes(value)) {
            activeFilters[type].push(value);
          }
        });

        // Filter papers
        document.querySelectorAll('.paper-card').forEach(card => {
          const cardSource = card.dataset.source;
          const cardLabel = card.dataset.label;

          let show = true;

          if (activeFilters.source.length > 0 && !activeFilters.source.includes(cardSource)) {
            show = false;
          }

          if (activeFilters.label.length > 0 && !activeFilters.label.includes(cardLabel)) {
            show = false;
          }

          card.style.display = show ? 'block' : 'none';
        });

        // Update group counts
        document.querySelectorAll('section[data-group]').forEach(section => {
          const visibleCards = section.querySelectorAll('.paper-card:not([style*="display: none"])').length;
          const countEl = section.querySelector('h2 + span, .text-text-secondary');
          // Note: This simple approach may not update counts correctly for all layouts
        });
      });
    });
  </script>
</body>
</html>
