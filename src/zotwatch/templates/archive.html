<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZotWatch 文献归档</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bg-primary': '#f8fafc',
            'bg-card': '#ffffff',
            'bg-hover': '#f1f5f9',
            'text-primary': '#1e293b',
            'text-secondary': '#64748b',
            'border-color': '#e2e8f0',
            'accent': '#2563eb',
            'accent-hover': '#1d4ed8',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .content-container {
      max-width: 64rem;
      margin: 0 auto;
      padding: 0 1rem;
    }

    @media (min-width: 768px) {
      .content-container {
        padding: 0 2rem;
      }
    }

    .section-expand {
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }

    .section-expand.collapsed {
      max-height: 0;
    }

    .section-expand.expanded {
      max-height: none;
    }

    .view-btn.active {
      background-color: #2563eb;
      color: white;
    }

    .filter-tag {
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-tag:hover {
      background-color: #dbeafe;
    }

    .filter-tag.active {
      background-color: #2563eb;
      color: white;
    }
  </style>
</head>

<body class="bg-bg-primary min-h-screen text-text-primary">
  <!-- Header -->
  <header class="bg-bg-card border-b border-border-color sticky top-0 z-10">
    <div class="content-container py-4 md:py-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-text-primary">ZotWatch 文献归档</h1>
          <p class="text-xs md:text-sm text-text-secondary mt-1">
            共 {{ stats.total }} 篇论文 ·
            最后更新: {{ generated_at.strftime('%Y-%m-%d %H:%M') }} {{ timezone_name }}
          </p>
        </div>
        <!-- Stats badges -->
        <div class="flex flex-wrap gap-2">
          <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
            必读 {{ stats.must_read }}
          </span>
          <span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">
            推荐 {{ stats.consider }}
          </span>
          <span class="px-3 py-1 bg-bg-hover text-text-secondary rounded-full text-sm">
            参考 {{ stats.total - stats.must_read - stats.consider }}
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <nav class="bg-bg-card border-b border-border-color py-3">
    <div class="content-container">
      <!-- View Switcher -->
      <div class="flex flex-wrap items-center gap-3 mb-3">
        <span class="text-sm text-text-secondary">分组方式:</span>
        <div class="flex gap-1">
          <a href="archive.html"
            class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover {{ 'active' if group_by == 'date' }}">按日期</a>
          <a href="archive-venue.html"
            class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover {{ 'active' if group_by == 'venue' }}">按期刊</a>
          <a href="archive-source.html"
            class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover {{ 'active' if group_by == 'source' }}">按来源</a>
          <a href="archive-label.html"
            class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover {{ 'active' if group_by == 'label' }}">按标签</a>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap items-center gap-3">
        <span class="text-sm text-text-secondary">筛选:</span>
        <!-- Source Filter -->
        <div class="flex gap-1">
          {% for src in sources %}
          <span class="filter-tag px-2 py-1 bg-bg-hover rounded text-xs" data-filter="source"
            data-value="{{ src.source }}">
            {{ src.source }} ({{ src.count }})
          </span>
          {% endfor %}
        </div>
        <!-- Label Filter -->
        <div class="flex gap-1">
          <span class="filter-tag px-2 py-1 bg-green-50 text-green-700 rounded text-xs" data-filter="label"
            data-value="must_read">必读</span>
          <span class="filter-tag px-2 py-1 bg-amber-50 text-amber-700 rounded text-xs" data-filter="label"
            data-value="consider">推荐</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="py-6">
    <div class="content-container">
      {% for group_name, works in grouped_works.items() %}
      <section class="mb-8" data-group="{{ group_name }}">
        <!-- Group Header -->
        <div class="flex items-center justify-between mb-4 pb-2 border-b border-border-color">
          <h2 class="text-lg font-bold text-text-primary flex items-center gap-2">
            {% if group_by == 'label' %}
            {% if group_name == 'must_read' %}
            <span class="w-3 h-3 bg-green-500 rounded-full"></span>必读
            {% elif group_name == 'consider' %}
            <span class="w-3 h-3 bg-amber-500 rounded-full"></span>推荐
            {% else %}
            <span class="w-3 h-3 bg-gray-400 rounded-full"></span>参考
            {% endif %}
            {% else %}
            {{ group_name }}
            {% endif %}
          </h2>
          <span class="text-sm text-text-secondary" data-count>{{ works|length }} 篇</span>
        </div>

        <!-- Works List (Virtualized) -->
        <div class="virtual-list" data-virtual-list data-group="{{ group_name }}">
          <div class="virtual-spacer" data-spacer-top></div>
          <div class="space-y-4" data-virtual-items></div>
          <div class="virtual-spacer" data-spacer-bottom></div>
        </div>
      </section>
      {% endfor %}
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-bg-card border-t border-border-color mt-12">
    <div class="content-container py-6 text-center text-sm text-text-secondary">
      灵感来自 <a href="https://github.com/Yorks0n/ZotWatch"
        class="text-accent hover:text-accent-hover transition-colors">ZotWatch</a>
      · 数据来源: arXiv, Crossref, EarthArXiv
    </div>
  </footer>

  <script>
    window.works = [
      {% for group_name, works in grouped_works.items() %}
      {% for work in works %}
      {
        key: {{ (group_name ~ '-' ~ loop.index0)|tojson }},
        group: {{ group_name|tojson }},
        label: {{ work.label|tojson }},
        source: {{ work.source|tojson }},
        score: {{ work.score|tojson }},
        publishedDisplay: {{ (work.published.strftime('%Y-%m-%d') if work.published else work.extra.run_date)|tojson }},
        title: {{ work.title|tojson }},
        translatedTitle: {{ work.translated_title|tojson }},
        url: {{ (work.url or '#')|tojson }},
        venue: {{ (work.venue or '未知来源')|tojson }},
        isChineseCore: {{ work.is_chinese_core|tojson }},
        impactFactor: {{ work.impact_factor|tojson }},
        authors: {{ work.authors|tojson }},
        doi: {{ work.doi|tojson }},
        abstract: {{ work.abstract|tojson }},
        summary: {{ work.summary|tojson }},
        similarity: {{ work.similarity|tojson }},
        impactFactorScore: {{ work.impact_factor_score|tojson }}
      }{{ "," if not (loop.last and loop.parent.last) else "" }}
      {% endfor %}
      {% endfor %}
    ];

    function toggleSection(id) {
      const el = document.getElementById(id);
      const icon = document.getElementById('icon-' + id);
      if (el.classList.contains('collapsed')) {
        el.classList.remove('collapsed');
        el.classList.add('expanded');
        if (icon) icon.style.transform = 'rotate(180deg)';
      } else {
        el.classList.remove('expanded');
        el.classList.add('collapsed');
        if (icon) icon.style.transform = 'rotate(0deg)';
      }
    }

    const escapeHtml = (value) => String(value ?? '').replace(/[&<>"']/g, (char) => {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      };
      return map[char] || char;
    });

    const formatNumber = (value, digits = 2) => {
      const number = Number(value);
      if (Number.isNaN(number)) {
        return '--';
      }
      return number.toFixed(digits);
    };

    const labelMeta = (label) => {
      if (label === 'must_read') {
        return { text: '必读', className: 'bg-green-100 text-green-700 border border-green-300' };
      }
      if (label === 'consider') {
        return { text: '推荐', className: 'bg-amber-100 text-amber-700 border border-amber-300' };
      }
      return { text: '参考', className: 'bg-bg-hover text-text-secondary border border-border-color' };
    };

    const renderCard = (work) => {
      const meta = labelMeta(work.label);
      const authors = Array.isArray(work.authors) ? work.authors : [];
      const authorText = authors.slice(0, 5).join('，') + (authors.length > 5 ? ' 等' : '');
      const abstractId = `abstract-${work.key}`;
      const summary = work.summary && work.summary.bullets ? work.summary.bullets : null;
      const venueBadge = work.isChineseCore
        ? '<span class="ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded">中文核心</span>'
        : (work.impactFactor ? `<span class="ml-1 text-blue-600">(IF: ${escapeHtml(formatNumber(work.impactFactor, 1))})</span>` : '');
      const doiBlock = work.doi ? `
        <div class="text-xs text-text-secondary mb-3">
          <span class="font-medium mr-1">DOI:</span>
          <a href="https://doi.org/${escapeHtml(work.doi)}" target="_blank" rel="noopener"
            class="text-accent hover:underline">${escapeHtml(work.doi)}</a>
        </div>
      ` : '';
      const abstractBlock = work.abstract ? `
        <div class="bg-bg-hover/50 rounded-lg p-3 mb-3 border border-border-color">
          <button onclick="toggleSection('${abstractId}')"
            class="w-full text-left text-sm font-medium text-text-primary flex items-center justify-between">
            <span>原文摘要</span>
            <svg class="w-4 h-4 text-text-secondary transform transition-transform"
              id="icon-${abstractId}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div id="${abstractId}" class="section-expand collapsed">
            <p class="text-sm text-text-secondary mt-2 leading-relaxed">${escapeHtml(work.abstract)}</p>
          </div>
        </div>
      ` : '';
      const summaryBlock = summary ? `
        <div class="bg-accent/10 rounded-lg p-3 mb-3 border border-accent/30">
          <h4 class="text-sm font-semibold text-accent mb-2 flex items-center">
            <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-1H2a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z" />
            </svg>
            AI 总结
          </h4>
          <div class="space-y-1.5 text-sm text-text-primary">
            <p><span class="font-medium text-accent">研究问题：</span>${escapeHtml(summary.research_question || '')}</p>
            <p><span class="font-medium text-accent">研究方法：</span>${escapeHtml(summary.methodology || '')}</p>
            <p><span class="font-medium text-accent">主要发现：</span>${escapeHtml(summary.key_findings || '')}</p>
            <p><span class="font-medium text-accent">创新点：</span>${escapeHtml(summary.innovation || '')}</p>
          </div>
        </div>
      ` : '';

      return `
        <article
          class="paper-card bg-bg-card rounded-lg border border-border-color overflow-hidden hover:border-accent/50 transition-colors"
          data-source="${escapeHtml(work.source)}" data-label="${escapeHtml(work.label)}"
          data-venue="${escapeHtml(work.venue)}">
          <div class="p-4 md:p-5">
            <div class="flex items-center gap-2 mb-2 flex-wrap">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium ${meta.className}">
                ${meta.text}
              </span>
              <span class="text-xs text-text-secondary">评分 ${escapeHtml(formatNumber(work.score))}</span>
              <span class="text-xs text-text-secondary">·</span>
              <span class="text-xs text-text-secondary">${escapeHtml(work.source)}</span>
              <span class="text-xs text-text-secondary">· ${escapeHtml(work.publishedDisplay)}</span>
            </div>

            <div class="mb-2">
              <h3 class="text-base md:text-lg font-semibold text-text-primary leading-tight">
                <a href="${escapeHtml(work.url)}" target="_blank" rel="noopener"
                  class="hover:text-accent transition-colors">
                  ${escapeHtml(work.title)}
                </a>
              </h3>
              ${work.translatedTitle ? `<p class="text-sm text-text-secondary mt-0.5 leading-snug">${escapeHtml(work.translatedTitle)}</p>` : ''}
            </div>

            <div class="text-xs text-text-secondary mb-2" title="${escapeHtml(work.venue || '')}">
              ${escapeHtml(work.venue)}
              ${venueBadge}
            </div>

            <p class="text-sm text-text-secondary mb-3">${escapeHtml(authorText)}</p>

            ${doiBlock}
            ${abstractBlock}
            ${summaryBlock}

            <div class="pt-3 border-t border-border-color">
              <div class="flex flex-wrap gap-2 text-xs">
                <span class="px-2 py-1 bg-bg-hover rounded text-text-secondary">相似度 ${escapeHtml(formatNumber(work.similarity))}</span>
                <span class="px-2 py-1 bg-bg-hover rounded text-text-secondary">
                  期刊影响力 ${escapeHtml(formatNumber(work.impactFactorScore))}
                </span>
              </div>
            </div>
          </div>
        </article>
      `;
    };

    class VirtualList {
      constructor(container, items, options) {
        this.container = container;
        this.itemsEl = container.querySelector('[data-virtual-items]');
        this.topSpacer = container.querySelector('[data-spacer-top]');
        this.bottomSpacer = container.querySelector('[data-spacer-bottom]');
        this.items = items;
        this.options = options;
        this.lastRange = { start: -1, end: -1 };
      }

      setData(items) {
        this.items = items;
        this.refresh(true);
      }

      refresh(force = false) {
        const total = this.items.length;
        const itemFullHeight = this.options.estimatedItemHeight + this.options.itemGap;
        if (total === 0) {
          this.itemsEl.innerHTML = '';
          this.topSpacer.style.height = '0px';
          this.bottomSpacer.style.height = '0px';
          this.lastRange = { start: 0, end: 0 };
          return;
        }

        const containerTop = this.container.getBoundingClientRect().top + window.scrollY;
        const viewTop = window.scrollY;
        const viewBottom = viewTop + window.innerHeight;
        let start = Math.floor((viewTop - containerTop) / itemFullHeight);
        let end = Math.ceil((viewBottom - containerTop) / itemFullHeight);
        start = Math.max(0, start - this.options.overscan);
        end = Math.min(total, end + this.options.overscan);

        let rangeSize = end - start;
        if (total <= this.options.minItems) {
          start = 0;
          end = total;
        } else {
          if (rangeSize < this.options.minItems) {
            const needed = this.options.minItems - rangeSize;
            const growTop = Math.floor(needed / 2);
            start = Math.max(0, start - growTop);
            end = Math.min(total, end + (needed - growTop));
          }
          rangeSize = end - start;
          if (rangeSize > this.options.maxItems) {
            end = Math.min(total, start + this.options.maxItems);
          }
        }

        if (!force && start === this.lastRange.start && end === this.lastRange.end) {
          return;
        }

        this.lastRange = { start, end };
        this.topSpacer.style.height = `${start * itemFullHeight}px`;
        this.bottomSpacer.style.height = `${Math.max(0, total - end) * itemFullHeight}px`;
        this.itemsEl.innerHTML = this.items.slice(start, end).map(renderCard).join('');
      }
    }

    const virtualLists = new Map();
    const settings = {
      estimatedItemHeight: 320,
      itemGap: 16,
      overscan: 6,
      minItems: 50,
      maxItems: 200
    };

    const initialGroups = new Map();
    window.works.forEach((work) => {
      if (!initialGroups.has(work.group)) {
        initialGroups.set(work.group, []);
      }
      initialGroups.get(work.group).push(work);
    });

    document.querySelectorAll('[data-virtual-list]').forEach((container) => {
      const group = container.dataset.group;
      const list = new VirtualList(container, initialGroups.get(group) || [], settings);
      list.refresh(true);
      virtualLists.set(group, list);
    });

    const refreshAllLists = (force = false) => {
      virtualLists.forEach((list) => list.refresh(force));
    };

    window.addEventListener('scroll', () => refreshAllLists());
    window.addEventListener('resize', () => refreshAllLists(true));

    // Filter functionality
    document.querySelectorAll('.filter-tag').forEach(tag => {
      tag.addEventListener('click', function () {
        const filterType = this.dataset.filter;
        const filterValue = this.dataset.value;

        // Toggle active state
        this.classList.toggle('active');

        // Get all active filters
        const activeFilters = {
          source: [],
          label: []
        };

        document.querySelectorAll('.filter-tag.active').forEach(activeTag => {
          const type = activeTag.dataset.filter;
          const value = activeTag.dataset.value;
          if (!activeFilters[type].includes(value)) {
            activeFilters[type].push(value);
          }
        });

        const filteredWorks = window.works.filter((work) => {
          if (activeFilters.source.length > 0 && !activeFilters.source.includes(work.source)) {
            return false;
          }
          if (activeFilters.label.length > 0 && !activeFilters.label.includes(work.label)) {
            return false;
          }
          return true;
        });

        const grouped = new Map();
        filteredWorks.forEach((work) => {
          if (!grouped.has(work.group)) {
            grouped.set(work.group, []);
          }
          grouped.get(work.group).push(work);
        });

        document.querySelectorAll('section[data-group]').forEach((section) => {
          const group = section.dataset.group;
          const list = virtualLists.get(group);
          if (list) {
            list.setData(grouped.get(group) || []);
          }
          const countEl = section.querySelector('[data-count]');
          if (countEl) {
            const count = (grouped.get(group) || []).length;
            countEl.textContent = `${count} 篇`;
          }
        });
      });
    });
  </script>
</body>

</html>
